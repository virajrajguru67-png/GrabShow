# StreamFlix Backend

TypeScript + Express service backed by MySQL (Prisma ORM). This scaffold will be expanded to fulfil the
Flutter frontend requirements documented in `../docs/backend_requirements.md`.

## Prerequisites

- Node.js 20+
- pnpm, npm, or yarn (examples below use `npm`)
- MySQL 8.x running locally (`root` user, no password) with a database named `streamflix`

## Getting Started

1. Copy `env.sample` to `.env` and adjust values as needed:

   ```bash
   cp env.sample .env
   ```

   Environment variables:
   - `PORT` (default `5000`)
   - `JWT_SECRET`, `JWT_EXPIRES_IN`, `REFRESH_TOKEN_TTL_DAYS`
   - `DATABASE_URL` (e.g. `mysql://root:@localhost:3306/streamflix`)
   - Optional: `ADMIN_SEED_PASSWORD` to override the default password for the seed admin account

2. Install dependencies and generate the Prisma client:

   ```bash
   npm install
   npm run prisma:generate
   ```

3. Create a migration (or apply existing ones) and seed the development admin user:

   ```bash
   npm run prisma:migrate -- --name auth
   npm run prisma:seed
   ```

   The seed creates/updates `admin@developer.com` with password `Admin@123` (or the value supplied via `ADMIN_SEED_PASSWORD`).

4. Launch the development server:

   ```bash
   npm run dev
   ```

   The API listens at `http://localhost:5000`. Health check: `GET /healthz`.

## API Surface (development snapshot)

- `GET /auth/*`, `POST /auth/*` – customer auth + refresh
- `POST /admin/login`, `/admin/movies`, `/admin/operations/*` – admin console APIs
- `GET /catalog/movies` – list movies with filters (`filter`, `q`, `genre`, `language`, `limit`)
- `GET /catalog/movies/:idOrSlug` – detailed movie payload (showtimes, pricing, metadata)
- `GET /catalog/showtimes/:id/seats` – seat availability map for seat selection
- `POST /catalog/bookings` / `GET /catalog/bookings/:reference` – customer booking flows
- `POST /payments/audit` – client-side payment audit log

## Project Structure

```
backend/
├── prisma/
│   ├── schema.prisma     # Prisma schema (authentication & admin base models)
│   ├── seed.ts           # Seeds default admin account
│   └── migrations/       # Generated by Prisma migrate commands
├── src/
│   ├── app.ts            # Express app factory with middleware
│   ├── config/
│   │   ├── env.ts        # Typed environment loader (dotenv + zod)
│   │   └── index.ts      # Barrel export
│   ├── errors/           # AppError helper
│   ├── middleware/       # Error handling middleware
│   ├── modules/
│   │   └── auth/         # Auth schemas & token helpers
│   ├── routes/           # Express routers (auth, admin, health)
│   ├── services/
│   │   └── prisma.ts     # Prisma client singleton
│   └── utils/            # Utility helpers (asyncHandler, password)
├── package.json          # Scripts & dependencies
├── tsconfig.json         # TypeScript compiler options
└── env.sample            # Sample environment configuration
```

## Next Steps

- Implement authentication-protected routes and authorization guards.
- Flesh out Prisma models for movies, showtimes, bookings, etc., then expose admin/customer endpoints.
- Add automated tests and CI configuration.
